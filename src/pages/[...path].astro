---
// SSR route - do not prerender
export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import '@/styles/global.css';
import CompanyPage from '@/components/company-page.astro';
import { getSupabase, normalizeVat, formatVat, slugifyCompanyName } from '@/lib';
import type { JuridicalSituation, CompanyContact, FinancialSummary } from '@/lib/db/types';
import type { RelatedCompany } from '@/lib/queries/related-companies';
import { getNaceDescription } from '@/lib/data/nace-codes';

// Supported languages
const SUPPORTED_LANGS = ['fr', 'nl', 'en'] as const;
type Lang = (typeof SUPPORTED_LANGS)[number];

// Parse the path: /[lang]/[vat]/[slug]
const path = Astro.params.path || '';
const segments = path.split('/').filter(Boolean);

// Validate we have exactly 3 segments
if (segments.length !== 3) {
  return new Response('Not Found', { status: 404 });
}

const [lang, vat, slug] = segments;

// Validate language
if (!SUPPORTED_LANGS.includes(lang as Lang)) {
  return Astro.redirect('/fr', 302);
}

// Normalize VAT number
const normalizedVat = normalizeVat(vat);
if (!normalizedVat) {
  return new Response('Invalid VAT number', { status: 400 });
}

// Fetch company with related data in a single query
const supabase = getSupabase();
const { data: result, error } = await supabase.rpc('get_company_with_related', {
  p_vat_number: normalizedVat,
  p_lang: lang,
  p_limit: 3,
});

// Handle not found
if (error || !result?.company) {
  return new Response('Company not found', { status: 404 });
}

const company = result.company;
const similarCompanies = (result.similar || []) as RelatedCompany[];
const neighborCompanies = (result.neighbors || []) as RelatedCompany[];

// Generate canonical slug from current company name
const canonicalSlug = slugifyCompanyName(company.name);

// SEO Guardrail: 301 redirect if slug doesn't match
if (slug !== canonicalSlug) {
  return Astro.redirect(`/${lang}/${normalizedVat}/${canonicalSlug}`, 301);
}

// Transform address to use language-specific fields
const rawAddress = company.address as {
  street_fr?: string;
  street_nl?: string;
  number?: string;
  box?: string;
  postal_code?: string;
  city_fr?: string;
  city_nl?: string;
  country?: string;
} | null;

// Prepare related data
const relatedData = {
  similar: similarCompanies,
  neighbors: neighborCompanies,
  sectorName: company.nace_main ? getNaceDescription(company.nace_main, lang as 'fr' | 'nl' | 'en') : null,
  postalCode: rawAddress?.postal_code ?? null,
  cityName: lang === 'nl' ? rawAddress?.city_nl : rawAddress?.city_fr,
};

const transformedAddress = rawAddress
  ? {
      street: lang === 'nl' ? rawAddress.street_nl : rawAddress.street_fr,
      number: rawAddress.number,
      box: rawAddress.box,
      postal_code: rawAddress.postal_code,
      city: lang === 'nl' ? rawAddress.city_nl : rawAddress.city_fr,
      country: rawAddress.country,
    }
  : null;

// Prepare company data for the component
const companyData = {
  name: company.name,
  vat_number: company.vat_number,
  formatted_vat: formatVat(company.vat_number),
  slug: company.slug,
  legal_form: company.legal_form,
  status: company.status as 'active' | 'stopped',
  juridical_situation: company.juridical_situation as JuridicalSituation,
  start_date: company.start_date,
  address: transformedAddress,
  contact: company.contact as CompanyContact | null,
  nace_codes: company.nace_codes,
  nace_main: company.nace_main,
  financial_summary: company.financial_summary as FinancialSummary | null,
  updated_at: company.updated_at,
};

// Build SEO title: "Company Name (SRL) - City (BE 0123456789) | FirmaCheck"
const legalFormPart = company.legal_form ? ` (${company.legal_form})` : '';
const cityPart = transformedAddress?.city ? ` - ${transformedAddress.city}` : '';
const vatPart = ` (BE ${company.vat_number})`;
const pageTitle = `${company.name}${legalFormPart}${cityPart}${vatPart} | FirmaCheck`;

// Build SEO meta description based on data richness
const financials = company.financial_summary as FinancialSummary | null;
const statusText = company.status === 'active' ? 'Active' : 'Stopped';

const formatCompact = (value: number): string => {
  if (value >= 1_000_000) return `€${(value / 1_000_000).toFixed(1)}M`;
  if (value >= 1_000) return `€${(value / 1_000).toFixed(0)}k`;
  return `€${value}`;
};

let pageDescription: string;
if (financials?.turnover) {
  // Rich data template
  const turnoverText = `Turnover ${financials.year || ''}: ${formatCompact(financials.turnover)}`;
  const profitText = financials.profit_loss !== undefined
    ? `. Profit: ${formatCompact(financials.profit_loss)}`
    : '';
  pageDescription = `Financial report for ${company.name} (BE ${company.vat_number}). ${turnoverText}${profitText}. Check solvency, liquidity, and download annual accounts.`;
} else {
  // Basic data template
  const locationText = transformedAddress?.city
    ? ` in ${transformedAddress.city}${rawAddress?.postal_code ? ` (${rawAddress.postal_code})` : ''}`
    : '';
  const legalText = company.legal_form ? ` ${company.legal_form}` : '';
  pageDescription = `${company.name}${legalText}${locationText}. VAT BE ${company.vat_number}. Status: ${statusText}. View address, contact info, and official publications on FirmaCheck.`;
}

// SEO: Canonical URL and alternate languages
const siteUrl = 'https://firmacheck.be';
const canonicalUrl = `${siteUrl}/${lang}/${company.vat_number}/${company.slug}`;
const alternateUrls = [
  { lang: 'fr', url: `${siteUrl}/fr/${company.vat_number}/${company.slug}` },
  { lang: 'nl', url: `${siteUrl}/nl/${company.vat_number}/${company.slug}` },
  { lang: 'en', url: `${siteUrl}/en/${company.vat_number}/${company.slug}` },
];

// SEO: JSON-LD structured data (Organization schema)
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: company.name,
  legalName: company.name,
  taxID: `BE ${company.vat_number}`,
  ...(transformedAddress && {
    address: {
      '@type': 'PostalAddress',
      streetAddress: [transformedAddress.street, transformedAddress.number, transformedAddress.box].filter(Boolean).join(' '),
      postalCode: transformedAddress.postal_code,
      addressLocality: transformedAddress.city,
      addressCountry: 'BE',
    },
  }),
  ...(company.contact?.phone && { telephone: company.contact.phone }),
  ...(company.contact?.email && { email: company.contact.email }),
  ...(company.contact?.website && { url: company.contact.website }),
  ...(company.start_date && { foundingDate: company.start_date }),
};
---

<Layout
  title={pageTitle}
  description={pageDescription}
  canonicalUrl={canonicalUrl}
  alternateUrls={alternateUrls}
  jsonLd={jsonLd}
  lang={lang}
>
  <CompanyPage company={companyData} lang={lang} related={relatedData} />
</Layout>
