---
// SSR route - do not prerender
export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import '@/styles/global.css';
import CompanyPage from '@/components/company-page.astro';
import { getSupabase, normalizeVat, formatVat, slugifyCompanyName } from '@/lib';
import type { JuridicalSituation, CompanyContact, FinancialSummary } from '@/lib/db/types';

// Supported languages
const SUPPORTED_LANGS = ['fr', 'nl', 'en'] as const;
type Lang = (typeof SUPPORTED_LANGS)[number];

// Parse the path: /[lang]/[vat]/[slug]
const path = Astro.params.path || '';
const segments = path.split('/').filter(Boolean);

// Validate we have exactly 3 segments
if (segments.length !== 3) {
  return new Response('Not Found', { status: 404 });
}

const [lang, vat, slug] = segments;

// Validate language
if (!SUPPORTED_LANGS.includes(lang as Lang)) {
  return Astro.redirect('/fr', 302);
}

// Normalize VAT number
const normalizedVat = normalizeVat(vat);
if (!normalizedVat) {
  return new Response('Invalid VAT number', { status: 400 });
}

// Fetch company from database
const supabase = getSupabase();
const { data: company, error } = await supabase
  .from('companies')
  .select('*')
  .eq('vat_number', normalizedVat)
  .single();

// Handle not found
if (error || !company) {
  return new Response('Company not found', { status: 404 });
}

// Generate canonical slug from current company name
const canonicalSlug = slugifyCompanyName(company.name);

// SEO Guardrail: 301 redirect if slug doesn't match
if (slug !== canonicalSlug) {
  return Astro.redirect(`/${lang}/${normalizedVat}/${canonicalSlug}`, 301);
}

// Transform address to use language-specific fields
const rawAddress = company.address as {
  street_fr?: string;
  street_nl?: string;
  number?: string;
  box?: string;
  postal_code?: string;
  city_fr?: string;
  city_nl?: string;
  country?: string;
} | null;

const transformedAddress = rawAddress
  ? {
      street: lang === 'nl' ? rawAddress.street_nl : rawAddress.street_fr,
      number: rawAddress.number,
      box: rawAddress.box,
      postal_code: rawAddress.postal_code,
      city: lang === 'nl' ? rawAddress.city_nl : rawAddress.city_fr,
      country: rawAddress.country,
    }
  : null;

// Prepare company data for the component
const companyData = {
  name: company.name,
  vat_number: company.vat_number,
  formatted_vat: formatVat(company.vat_number),
  slug: company.slug,
  legal_form: company.legal_form,
  status: company.status as 'active' | 'stopped',
  juridical_situation: company.juridical_situation as JuridicalSituation,
  start_date: company.start_date,
  address: transformedAddress,
  contact: company.contact as CompanyContact | null,
  nace_codes: company.nace_codes,
  nace_main: company.nace_main,
  financial_summary: company.financial_summary as FinancialSummary | null,
  updated_at: company.updated_at,
};
---

<Layout title={`${company.name} | FirmaCheck`} lang={lang}>
  <CompanyPage company={companyData} lang={lang} />
</Layout>
