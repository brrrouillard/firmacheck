---
/**
 * FAQ Section - SEO-friendly frequently asked questions
 * Uses native HTML details/summary for zero JavaScript
 */

import { t } from '@/lib/i18n/translations';
import type { SupportedLang } from '@/lib/i18n/translations';
import type { FinancialSummary } from '@/lib/db/types';

interface Props {
  companyName: string;
  vatNumber: string;
  formattedVat: string;
  startDate: string | null;
  address: {
    street?: string;
    number?: string;
    box?: string;
    postal_code?: string;
    city?: string;
    country?: string;
  } | null;
  financialSummary: FinancialSummary | null;
  lang: string;
}

const { companyName, vatNumber, formattedVat, startDate, address, financialSummary, lang } = Astro.props;
const typedLang = (lang === 'nl' ? 'nl' : lang === 'en' ? 'en' : 'fr') as SupportedLang;

// Format address
const formatAddress = () => {
  if (!address) return null;
  const parts = [];
  if (address.street) {
    let streetLine = address.street;
    if (address.number) streetLine += ` ${address.number}`;
    if (address.box) streetLine += ` ${t(typedLang, 'identity', 'box')} ${address.box}`;
    parts.push(streetLine);
  }
  if (address.postal_code || address.city) {
    parts.push([address.postal_code, address.city].filter(Boolean).join(' '));
  }
  return parts.length > 0 ? parts.join(', ') : null;
};

// Format date
const formatDate = (dateStr: string | null) => {
  if (!dateStr) return null;
  const date = new Date(dateStr);
  const locale = typedLang === 'nl' ? 'nl-BE' : typedLang === 'en' ? 'en-GB' : 'fr-BE';
  return date.toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });
};

// Format currency
const formatCurrency = (value?: number) => {
  if (value === undefined || value === null) return null;
  const locale = typedLang === 'nl' ? 'nl-BE' : 'fr-BE';
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: 'EUR',
    maximumFractionDigits: 0,
  }).format(value);
};

// Build FAQ items dynamically based on available data
const faqItems: { question: string; answer: string }[] = [];

// VAT number - always available
faqItems.push({
  question: t(typedLang, 'faq', 'vatQuestion').replace('{company}', companyName),
  answer: t(typedLang, 'faq', 'vatAnswer').replace('{vat}', formattedVat),
});

// Creation date
if (startDate) {
  faqItems.push({
    question: t(typedLang, 'faq', 'creationQuestion').replace('{company}', companyName),
    answer: t(typedLang, 'faq', 'creationAnswer')
      .replace('{company}', companyName)
      .replace('{date}', formatDate(startDate) || ''),
  });
}

// Address
const formattedAddress = formatAddress();
if (formattedAddress) {
  faqItems.push({
    question: t(typedLang, 'faq', 'addressQuestion').replace('{company}', companyName),
    answer: t(typedLang, 'faq', 'addressAnswer')
      .replace('{company}', companyName)
      .replace('{address}', formattedAddress),
  });
}

// Employees
if (financialSummary?.employees !== undefined && financialSummary.employees !== null) {
  faqItems.push({
    question: t(typedLang, 'faq', 'employeesQuestion').replace('{company}', companyName),
    answer: t(typedLang, 'faq', 'employeesAnswer')
      .replace('{company}', companyName)
      .replace('{count}', financialSummary.employees.toString()),
  });
}

// Turnover
const formattedTurnover = formatCurrency(financialSummary?.turnover);
if (formattedTurnover) {
  faqItems.push({
    question: t(typedLang, 'faq', 'turnoverQuestion').replace('{company}', companyName),
    answer: t(typedLang, 'faq', 'turnoverAnswer')
      .replace('{company}', companyName)
      .replace('{amount}', formattedTurnover)
      .replace('{year}', financialSummary?.year?.toString() || ''),
  });
}

// Only render if we have items
const shouldRender = faqItems.length > 0;
---

{shouldRender && (
  <section>
    <div class="mx-auto max-w-5xl px-4 py-6 sm:px-6 lg:px-8">
      <h2 class="text-lg font-semibold mb-4">{t(typedLang, 'faq', 'title')}</h2>
      <div class="space-y-2">
        {faqItems.map((item) => (
          <details class="group rounded-lg border border-border bg-card">
            <summary class="flex cursor-pointer items-center justify-between px-4 py-3 text-sm font-medium hover:bg-muted/50 transition-colors [&::-webkit-details-marker]:hidden list-none">
              <span>{item.question}</span>
              <svg
                class="h-4 w-4 text-muted-foreground shrink-0 transition-transform duration-200 group-open:rotate-180"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-4 pb-3 text-sm text-muted-foreground">
              {item.answer}
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>
)}

<!-- FAQ Schema.org structured data for SEO -->
{shouldRender && (
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqItems.map(item => ({
      "@type": "Question",
      "name": item.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.answer
      }
    }))
  })} />
)}
