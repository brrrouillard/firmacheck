---
/**
 * Company Page - Progressive Disclosure Layout
 *
 * Layout:
 * 1. Hero Section - Name, VAT, status badge, action buttons
 * 2. Snapshot Grid - 3-column grid with Identity, Activity, Financial cards
 * 3. Deep Dive - Detailed financial data (if available)
 * 4. Footer - Data freshness, external links
 */

import HeroSection from './company/hero-section.astro';
import SnapshotGrid from './company/snapshot-grid.astro';
import IdentityCard from './company/identity-card.astro';
import ActivityCard from './company/activity-card.astro';
import FinancialPulseCard from './company/financial-pulse-card.astro';
import FunctionsCard from './company/functions-card.astro';
import EntityLinksCard from './company/entity-links-card.astro';
import FaqSection from './company/faq-section.astro';
import RelatedCompanies from './company/related-companies.astro';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { ExternalLink, Coins, TrendingUp, TrendingDown } from 'lucide-react';
import { t } from '@/lib/i18n/translations';
import type { SupportedLang } from '@/lib/i18n/translations';
import type {
  JuridicalSituation,
  CompanyContact,
  FinancialSummary,
  CompanyFunction,
  Qualification,
  EntityLink,
  NaceHistory,
  FiscalPeriod,
} from '@/lib/db/types';
import type { RelatedCompany } from '@/lib/queries/related-companies';

interface Props {
  company: {
    name: string;
    vat_number: string;
    formatted_vat: string | null;
    slug: string;
    legal_form: string | null;
    status: 'active' | 'stopped';
    juridical_situation: JuridicalSituation;
    start_date: string | null;
    address: {
      street?: string;
      number?: string;
      box?: string;
      postal_code?: string;
      city?: string;
      country?: string;
    } | null;
    contact: CompanyContact | null;
    nace_codes: string[] | null;
    nace_main: string | null;
    financial_summary: FinancialSummary | null;
    functions: CompanyFunction[] | null;
    // Extended KBO data
    capital: number | null;
    fiscal_year_end: string | null;
    annual_meeting_month: string | null;
    qualifications: Qualification[] | null;
    entity_links: EntityLink[] | null;
    nace_history: NaceHistory | null;
    exceptional_fiscal_periods: FiscalPeriod[] | null;
    updated_at: string;
  };
  lang: string;
  related: {
    similar: RelatedCompany[];
    neighbors: RelatedCompany[];
    sectorName: string | null;
    postalCode: string | null;
    cityName: string | null | undefined;
  };
}

const { company, lang, related } = Astro.props;
const typedLang = (lang === 'nl' ? 'nl' : lang === 'en' ? 'en' : 'fr') as SupportedLang;
const financials = company.financial_summary;

// Check if we have detailed financial data for the deep dive section
const hasDetailedFinancials = financials && (
  financials.gross_margin !== undefined ||
  financials.net_margin !== undefined ||
  financials.equity !== undefined
);

const formatCurrency = (value?: number) => {
  if (value === undefined || value === null) return null;
  const locale = typedLang === 'nl' ? 'nl-BE' : 'fr-BE';
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: 'EUR',
    maximumFractionDigits: 0,
  }).format(value);
};
---

<div class="min-h-screen bg-background">
  <!-- Hero Section -->
  <HeroSection
    name={company.name}
    formattedVat={company.formatted_vat || company.vat_number}
    vatNumber={company.vat_number}
    legalForm={company.legal_form}
    juridicalSituation={company.juridical_situation}
    status={company.status}
    qualifications={company.qualifications}
    updatedAt={company.updated_at}
    lang={lang}
  />

  <!-- Snapshot Grid -->
  <SnapshotGrid>
    <IdentityCard
      address={company.address}
      startDate={company.start_date}
      contact={company.contact}
      capital={company.capital}
      fiscalYearEnd={company.fiscal_year_end}
      annualMeetingMonth={company.annual_meeting_month}
      lang={lang}
    />
    <ActivityCard
      naceMain={company.nace_main}
      naceCodes={company.nace_codes}
      legalForm={company.legal_form}
      naceHistory={company.nace_history}
      lang={lang}
    />
    <FinancialPulseCard
      financialSummary={company.financial_summary}
      lang={lang}
    />
  </SnapshotGrid>

  <!-- Management Section (if functions available) -->
  {company.functions && company.functions.length > 0 && (
    <section>
      <div class="mx-auto max-w-5xl px-4 py-6 sm:px-6 lg:px-8">
        <FunctionsCard functions={company.functions} lang={lang} />
      </div>
    </section>
  )}

  <!-- Corporate Structure Section (if entity links available) -->
  {company.entity_links && company.entity_links.length > 0 && (
    <section>
      <div class="mx-auto max-w-5xl px-4 py-6 sm:px-6 lg:px-8">
        <EntityLinksCard entityLinks={company.entity_links} lang={lang} />
      </div>
    </section>
  )}

  <!-- Deep Dive Section (if detailed financials available) -->
  {hasDetailedFinancials && (
    <section>
      <div class="mx-auto max-w-5xl px-4 py-6 sm:px-6 lg:px-8">
        <Card>
          <CardHeader className="pb-3">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2">
                <Coins className="h-5 w-5 text-muted-foreground" />
                <CardTitle className="text-base font-medium">
                  {t(typedLang, 'financials', 'detailedFinancials')}
                </CardTitle>
              </div>
              {financials?.year && (
                <Badge variant="secondary" className="text-xs font-normal">
                  {financials.year}
                </Badge>
              )}
            </div>
          </CardHeader>
          <CardContent>
            <div class="grid gap-6 sm:grid-cols-3">
              {/* Gross Margin */}
              {financials.gross_margin !== undefined && (
                <div>
                  <p class="text-xs text-muted-foreground">{t(typedLang, 'financials', 'grossMargin')}</p>
                  <div class="flex items-center gap-1.5 mt-1">
                    {financials.gross_margin >= 0 ? (
                      <TrendingUp className="h-4 w-4 text-green-600 dark:text-green-400" />
                    ) : (
                      <TrendingDown className="h-4 w-4 text-red-600 dark:text-red-400" />
                    )}
                    <p class={`text-lg font-semibold ${
                      financials.gross_margin >= 0
                        ? 'text-green-600 dark:text-green-400'
                        : 'text-red-600 dark:text-red-400'
                    }`}>
                      {formatCurrency(financials.gross_margin)}
                    </p>
                  </div>
                </div>
              )}

              {/* Net Margin */}
              {financials.net_margin !== undefined && (
                <div>
                  <p class="text-xs text-muted-foreground">{t(typedLang, 'financials', 'netMargin')}</p>
                  <div class="flex items-center gap-1.5 mt-1">
                    {financials.net_margin >= 0 ? (
                      <TrendingUp className="h-4 w-4 text-green-600 dark:text-green-400" />
                    ) : (
                      <TrendingDown className="h-4 w-4 text-red-600 dark:text-red-400" />
                    )}
                    <p class={`text-lg font-semibold ${
                      financials.net_margin >= 0
                        ? 'text-green-600 dark:text-green-400'
                        : 'text-red-600 dark:text-red-400'
                    }`}>
                      {formatCurrency(financials.net_margin)}
                    </p>
                  </div>
                </div>
              )}

              {/* Equity */}
              {financials.equity !== undefined && (
                <div>
                  <p class="text-xs text-muted-foreground">{t(typedLang, 'financials', 'equity')}</p>
                  <p class="text-lg font-semibold mt-1">
                    {formatCurrency(financials.equity)}
                  </p>
                </div>
              )}
            </div>
            {/* Exceptional Fiscal Periods Note */}
            {company.exceptional_fiscal_periods && company.exceptional_fiscal_periods.length > 0 && (
              <p class="mt-4 text-xs text-muted-foreground italic">
                * {company.exceptional_fiscal_periods.map(p =>
                  `${p.start_date} - ${p.end_date}`
                ).join(', ')}
              </p>
            )}
          </CardContent>
        </Card>
      </div>
    </section>
  )}

  <!-- FAQ Section -->
  <FaqSection
    companyName={company.name}
    vatNumber={company.vat_number}
    formattedVat={company.formatted_vat || company.vat_number}
    startDate={company.start_date}
    address={company.address}
    financialSummary={company.financial_summary}
    lang={lang}
  />

  <!-- Related Companies -->
  <RelatedCompanies
    similar={related.similar}
    neighbors={related.neighbors}
    sectorName={related.sectorName}
    postalCode={related.postalCode}
    cityName={related.cityName ?? null}
    lang={lang}
  />

  <!-- Footer -->
  <footer class="py-4">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
      <div class="flex justify-end gap-4">
        <a
          href={`https://kbopub.economie.fgov.be/kbopub/zoeknummerform.html?nummer=${company.vat_number}&actionLu=Recherche`}
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          <span>{t(typedLang, 'footer', 'viewOnKbo')}</span>
          <ExternalLink className="h-3 w-3" />
        </a>
        <a
          href={`https://consult.cbso.nbb.be/consult-enterprise/${company.vat_number}`}
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          <span>{t(typedLang, 'footer', 'viewOnNbb')}</span>
          <ExternalLink className="h-3 w-3" />
        </a>
      </div>
    </div>
  </footer>
</div>
